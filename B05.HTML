<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Administración - Descuentos y Promociones</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<style>
* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

body {
    font-family: Arial, sans-serif;
    background: #f4f4f4;
    padding: 20px;
}

.container {
    max-width: 1200px;
    margin: auto;
    background: white;
    padding: 20px;
    border-radius: 10px;
    border: 1px solid #ccc;
    display: grid;
    gap: 2rem;
}

h2 {
    text-align: center;
    color: #007BFF;
}

/* Tabla */
table {
    width: 100%;
    border-collapse: collapse;
}

th, td {
    padding: 10px;
    border: 1px solid #ddd;
    text-align: left;
}

th {
    background: #007BFF;
    color: white;
}

/* Botones: todos verdes */
button, .btn-edit, .btn-delete, .btn-add {
    background-color: #28a745 !important;
    color: white !important;
    padding: 0.6rem 1rem;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
    transition: background 0.3s ease;
}

button:hover, .btn-edit:hover, .btn-delete:hover, .btn-add:hover {
    background-color: #218838 !important;
}

/* Formulario */
.discount-form {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 1rem;
    background: #f9f9f9;
    padding: 15px;
    border-radius: 5px;
}

label {
    display: block;
    margin-bottom: 0.3rem;
    font-size: 0.9rem;
    font-weight: bold;
}

.full-width {
    grid-column: span 3;
}

input, select {
    width: 100%;
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 5px;
}

.discount-form button {
    grid-column: span 3;
    background-color: #28a745 !important;
    color: white !important;
    padding: 0.8rem;
}

.discount-form button:hover {
    background-color: #218838 !important;
}

#discount-id-field {
    display: none;
}
</style>
</head>
<body>
<div class="container">
    <h2 class = "text-success fw-bold">Administrar Descuentos y Promociones</h2>

    <form class="discount-form" id="discountForm">
        <h3 class="full-width" id="formTitle">Agregar Nueva Promoción</h3>

        <input type="hidden" id="discount-id" name="id">

        <div class="full-width">
            <label for="name">Nombre de la promoción</label>
            <input type="text" id="name" name="name" placeholder="Ej: Promo Verano" required>
        </div>
        <div class="full-width">
            <label for="description">Descripción</label>
            <input type="text" id="description" name="description" placeholder="Ej: Descuento del 20% en productos seleccionados" required>
        </div>
        <div>
            <label for="discount">Descuento (%)</label>
            <input type="number" id="discount" name="discount" placeholder="20" min="1" max="100" required>
        </div>
        <div>
            <label for="start-date">Fecha de inicio</label>
            <input type="date" id="start-date" name="startDate" required>
        </div>
        <div>
            <label for="end-date">Fecha de fin</label>
            <input type="date" id="end-date" name="endDate" required>
        </div>

        <div class="full-width">
            <button type="submit" class="btn-add" id="submitButton">
                <i class="bi bi-plus-circle me-2"></i>Agregar promoción
            </button>
            <button type="button" class="btn btn-secondary" onclick="resetForm()" id="cancelButton" style="display:none; margin-top: 10px;">
                <i class="bi bi-x-circle me-2"></i>Cancelar Edición
            </button>
        </div>
    </form>

    <hr>

    <h3>Lista de Promociones Actuales</h3>
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Descripción</th>
                <th>Descuento (%)</th>
                <th>Fecha Inicio</th>
                <th>Fecha Fin</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="promotionsTableBody"></tbody>
    </table>
</div>

<script>
const STORAGE_KEY = "promociones";

function getPromotions() {
    return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
}

function savePromotions(promotions) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(promotions));
}

function formatDate(dateString) {
    if (!dateString) return '';
    const [year, month, day] = dateString.split('-');
    return `${day}-${month}-${year}`;
}

function renderPromotionsTable() {
    const promotions = getPromotions();
    const tbody = document.getElementById("promotionsTableBody");
    tbody.innerHTML = '';

    if (promotions.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" class="text-center">No hay promociones activas.</td></tr>`;
        return;
    }

    promotions.forEach(promo => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${promo.id}</td>
            <td>${promo.name}</td>
            <td>${promo.description}</td>
            <td>${promo.discount}%</td>
            <td>${formatDate(promo.startDate)}</td>
            <td>${formatDate(promo.endDate)}</td>
            <td class="actions">
                <button class="btn-edit btn-sm" onclick="editPromotion(${promo.id})">
                    <i class="bi bi-pencil-square"></i> Editar
                </button>
                <button class="btn-delete btn-sm" onclick="deletePromotion(${promo.id})">
                    <i class="bi bi-trash"></i> Eliminar
                </button>
            </td>
        `;
    });
}

const discountForm = document.getElementById("discountForm");
const formTitle = document.getElementById("formTitle");
const submitButton = document.getElementById("submitButton");
const cancelButton = document.getElementById("cancelButton");

discountForm.addEventListener("submit", function(event) {
    event.preventDefault();

    const id = document.getElementById("discount-id").value;
    const name = document.getElementById("name").value.trim();
    const description = document.getElementById("description").value.trim();
    const discount = parseInt(document.getElementById("discount").value);
    const startDate = document.getElementById("start-date").value;
    const endDate = document.getElementById("end-date").value;

    if (new Date(startDate) > new Date(endDate)) {
        alert("La fecha de fin debe ser igual o posterior a la fecha de inicio.");
        return;
    }

    let promotions = getPromotions();

    if (id) {
        const index = promotions.findIndex(p => p.id == id);
        if (index !== -1) {
            promotions[index] = { id: parseInt(id), name, description, discount, startDate, endDate };
            alert(`Promoción con ID ${id} actualizada.`);
        }
    } else {
        const newId = promotions.length > 0 ? Math.max(...promotions.map(p => p.id)) + 1 : 1;
        promotions.push({ id: newId, name, description, discount, startDate, endDate });
        alert(`Promoción "${name}" agregada con éxito.`);
    }

    savePromotions(promotions);
    renderPromotionsTable();
    resetForm();
});

function editPromotion(id) {
    const promo = getPromotions().find(p => p.id === id);
    if (!promo) return;

    document.getElementById("discount-id").value = promo.id;
    document.getElementById("name").value = promo.name;
    document.getElementById("description").value = promo.description;
    document.getElementById("discount").value = promo.discount;
    document.getElementById("start-date").value = promo.startDate;
    document.getElementById("end-date").value = promo.endDate;

    formTitle.textContent = `Editar Promoción ID: ${promo.id}`;
    submitButton.innerHTML = '<i class="bi bi-save me-2"></i>Guardar Cambios';
    submitButton.classList.replace('btn-add', 'btn-primary');
    cancelButton.style.display = 'block';
    window.scrollTo(0, 0);
}

function resetForm() {
    discountForm.reset();
    document.getElementById("discount-id").value = '';
    formTitle.textContent = 'Agregar Nueva Promoción';
    submitButton.innerHTML = '<i class="bi bi-plus-circle me-2"></i>Agregar promoción';
    submitButton.classList.replace('btn-primary', 'btn-add');
    cancelButton.style.display = 'none';
}

function deletePromotion(id) {
    if (confirm(`¿Estás seguro de eliminar la promoción con ID ${id}?`)) {
        const updatedPromotions = getPromotions().filter(p => p.id !== id);
        savePromotions(updatedPromotions);
        renderPromotionsTable();
        resetForm();
        alert(`Promoción con ID ${id} eliminada.`);
    }
}

document.addEventListener("DOMContentLoaded", function() {
    if (getPromotions().length === 0) {
        savePromotions([
            { id: 1, name: "Promo Verano", description: "Descuento del 20% en productos seleccionados", discount: 20, startDate: "2025-12-01", endDate: "2025-12-31" },
            { id: 2, name: "Cyber Lunes", description: "10% de descuento en toda la tienda", discount: 10, startDate: "2025-11-25", endDate: "2025-11-27" }
        ]);
    }
    renderPromotionsTable();
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
